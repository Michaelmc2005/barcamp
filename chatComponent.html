<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Encrypted Chat</title>
  <script src="/socket.io/socket.io.js"></script>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background-color: #1e1e1e;
      color: #ffffff;
    }
    .container {
      display: flex;
      height: 100vh;
    }
    .sidebar {
      width: 250px;
      background-color: #2d2d2d;
      padding: 20px;
      box-sizing: border-box;
      overflow-y: auto;
    }
    .sidebar h2 {
      margin-top: 0;
    }
    .contact-list {
      list-style-type: none;
      padding: 0;
    }
    .contact-list li {
      padding: 10px;
      margin-bottom: 5px;
      cursor: pointer;
      border-radius: 5px;
    }
    .contact-list li.active,
    .contact-list li:hover {
      background-color: #3d3d3d;
    }
    .chat-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 20px;
      box-sizing: border-box;
    }
    .chat-header {
      padding-bottom: 10px;
      border-bottom: 1px solid #3d3d3d;
    }
    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 10px 0;
    }
    .message {
      margin-bottom: 15px;
      max-width: 60%;
      word-wrap: break-word;
    }
    .message.sent {
      align-self: flex-end;
      background-color: #4e9a06;
    }
    .message.received {
      align-self: flex-start;
      background-color: #555555;
    }
    .message p {
      margin: 0;
      padding: 10px;
      border-radius: 10px;
    }
    .chat-input {
      display: flex;
      border-top: 1px solid #3d3d3d;
      padding-top: 10px;
    }
    .chat-input textarea {
      flex: 1;
      background-color: #2d2d2d;
      color: #ffffff;
      border: none;
      padding: 10px;
      resize: none;
      height: 60px;
    }
    .chat-input button {
      background-color: #4e9a06;
      color: #ffffff;
      border: none;
      padding: 0 20px;
      cursor: pointer;
    }
    .chat-input button:hover {
      background-color: #3d7a04;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="sidebar">
      <h2>Contacts</h2>
      <ul class="contact-list" id="contact-list"></ul>
    </div>
    <div class="chat-area">
      <div class="chat-header">
        <h2 id="chat-header">Select a contact to start chatting</h2>
      </div>
      <div class="chat-messages" id="chat-messages"></div>
      <div class="chat-input">
        <textarea id="message-input" placeholder="Type your message here"></textarea>
        <button id="send-btn">Send</button>
      </div>
    </div>
  </div>

  <script>
    let username;
    let privateKey;
    let socket;
    let contacts = [];
    let currentChatUser = null;
    let messagesStore = {};

    async function loadPrivateKey() {
      const keyData = JSON.parse(localStorage.getItem("privateKey"));
      privateKey = await window.crypto.subtle.importKey(
        "jwk",
        keyData,
        {
          name: "RSA-OAEP",
          hash: "SHA-256",
        },
        true,
        ["decrypt"]
      );
    }

    async function loadContacts() {
      const response = await fetch("/users");
      const users = await response.json();
      contacts = users.filter((user) => user !== username);
      const contactListEl = document.getElementById("contact-list");
      contactListEl.innerHTML = "";
      contacts.forEach((contact) => {
        const li = document.createElement("li");
        li.textContent = contact;
        li.dataset.username = contact;
        li.addEventListener("click", () => {
          selectChatUser(contact);
        });
        contactListEl.appendChild(li);
      });
    }

    function selectChatUser(contact) {
      currentChatUser = contact;
      document.getElementById("chat-header").textContent = `Chat with ${contact}`;
      const contactItems = document.querySelectorAll(".contact-list li");
      contactItems.forEach((item) => {
        item.classList.toggle("active", item.dataset.username === contact);
      });
      loadChatMessages(contact);
    }

    function loadChatMessages(contact) {
      const chatMessagesEl = document.getElementById("chat-messages");
      chatMessagesEl.innerHTML = "";
      const messages = messagesStore[contact] || [];
      messages.forEach((msg) => {
        appendMessage(msg.sender, msg.message, msg.type, false);
      });
    }

    async function encryptMessage(publicKeyJwk, message) {
      const publicKey = await window.crypto.subtle.importKey(
        "jwk",
        publicKeyJwk,
        {
          name: "RSA-OAEP",
          hash: "SHA-256",
        },
        true,
        ["encrypt"]
      );
      const encoder = new TextEncoder();
      const encodedMessage = encoder.encode(message);
      const encrypted = await window.crypto.subtle.encrypt(
        { name: "RSA-OAEP" },
        publicKey,
        encodedMessage
      );
      return Array.from(new Uint8Array(encrypted));
    }

    async function decryptMessage(encryptedArray) {
      const encrypted = new Uint8Array(encryptedArray);
      const decrypted = await window.crypto.subtle.decrypt(
        { name: "RSA-OAEP" },
        privateKey,
        encrypted
      );
      const decoder = new TextDecoder();
      return decoder.decode(decrypted);
    }

    async function sendMessage() {
      const messageInput = document.getElementById("message-input");
      const message = messageInput.value.trim();
      if (!currentChatUser) {
        alert("Please select a contact to chat with.");
        return;
      }
      if (!message) {
        return;
      }
      const response = await fetch("/publicKey/" + currentChatUser);
      const { publicKey } = await response.json();
      const encryptedMessage = await encryptMessage(publicKey, message);
      socket.emit("sendMessage", {
        sender: username,
        recipient: currentChatUser,
        message: encryptedMessage,
      });
      appendMessage(username, message, "sent", true);
      messageInput.value = "";
    }

    function appendMessage(sender, content, type, store = true) {
      const chatMessagesEl = document.getElementById("chat-messages");
      if (store) {
        if (!messagesStore[currentChatUser]) {
          messagesStore[currentChatUser] = [];
        }
        messagesStore[currentChatUser].push({ sender, message: content, type });
      }
      if (sender === currentChatUser || sender === username) {
        const messageEl = document.createElement("div");
        messageEl.classList.add("message", type);
        const messageContent = document.createElement("p");
        messageContent.textContent = content;
        messageEl.appendChild(messageContent);
        chatMessagesEl.appendChild(messageEl);
        chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
      }
    }

    (async () => {
      const params = new URLSearchParams(window.location.search);
      username = params.get("username");
      await loadPrivateKey();
      await loadContacts();
      socket = io();
      socket.emit("register", { username });
      socket.on("newMessage", async (msg) => {
        const { sender, message } = msg;
        try {
          const decryptedMessage = await decryptMessage(message);
          if (!messagesStore[sender]) {
            messagesStore[sender] = [];
          }
          messagesStore[sender].push({ sender, message: decryptedMessage, type: "received" });
          if (currentChatUser === sender) {
            appendMessage(sender, decryptedMessage, "received", false);
          }
        } catch (error) {
          console.error("Failed to decrypt message:", error);
        }
      });
      const response = await fetch("/messages/" + username);
      const msgs = await response.json();
      for (const msg of msgs) {
        const decryptedMessage = await decryptMessage(msg.message);
        const contact = msg.sender === username ? msg.recipient : msg.sender;
        const type = msg.sender === username ? "sent" : "received";
        if (!messagesStore[contact]) {
          messagesStore[contact] = [];
        }
        messagesStore[contact].push({ sender: msg.sender, message: decryptedMessage, type });
      }
      if (contacts.length > 0) {
        selectChatUser(contacts[0]);
      }
    })();

    document.getElementById("send-btn").addEventListener("click", async () => {
      await sendMessage();
    });

    document.getElementById("message-input").addEventListener("keydown", (event) => {
      if (event.key === "Enter" && !event.shiftKey) {
        event.preventDefault();
        sendMessage();
      }
    });
  </script>
</body>
</html>
